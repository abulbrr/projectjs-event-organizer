<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <title>Events</title>
    <script src="./LocalStorage.js"></script>
    <script src="./HtmlCreator.js"></script>

</head>

<body>
    <nav>
        <div class="nav-wrapper green">
            <a href="./index.html" class="brand-logo left">projectjs-event-organizer</a>
            <ul id="nav-mobile" class="right">
                <li>
                    <a href="./createEvent.html">Create Event</a>
                </li>
                <li>
                    <a onClick="LocalStorage.logout()">
                        <i class="material-icons right">person_outline</i>
                    </a>
                </li>
                <li>
                    <a onClick="LocalStorage.lock()">LOCK SYSTEM
                    </a>
                </li>
                <li>
                    <a onClick="LocalStorage.unlock()">UNLOCK SYSTEM
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <div class="section">
            <p>
                <label>
                    <input onchange="render()" id="mostAttended" type="checkbox" />
                    <span for="mostAttended">mostAttended</span>

                </label>
            </p>
            <br>
            <p>
                <label>
                    <input onchange="render()" id="sfw" type="checkbox" />
                    <span>safe for work</span>
                </label>
            </p>
        </div>
        <div class="column s-12">
            <input type="text" name="nameFilter" id="nameFilter" placeholder="filter by name">
            <button onclick="render('nameFilter')" class="btn">apply</button>
        </div>
        <h2>Events</h2>
        <ul id="Events" class="collection">

        </ul>

    </div>


    <script>
        let options
        document.addEventListener('DOMContentLoaded', function () {
            var elems = document.querySelectorAll('select');
            var instances = M.FormSelect.init(elems, options);
        });
        var EventsList = LocalStorage.getEvents();
        render();
        function render(criteria = '') {
            $('#Events').innerHTML = ''
            let list = EventsList;

            if (criteria != '') {
                if (criteria == 'nameFilter') {
                    let value = $('#nameFilter').value
                    console.log(value)
                    let temp = CollectionUtils.find(list, (element) => {
                        console.log(element.name == value)
                        return element.name == value
                    })
                    if (temp != false) { 
                        list = []
                        list.push(temp)
                    }
                }
            }

            if ($('#mostAttended').checked == true) {
                console.log('most attended')
                let temp = CollectionUtils.max(EventsList)
                if (temp != false) {
                    list = []
                    list.push(CollectionUtils.max(EventsList))

                }

                console.log(list)
            }

            if ($('#sfw').checked == true) {
                console.log('is safe for work')
                list = CollectionUtils.filter(list, (element) => {
                    return element.isNsfw == false
                })
            }

            for (let index = 0; index < list.length; index++) {
                const event = list[index];
                renderEvent(event, index)

            }
        }

        console.log('EventsList: ', EventsList);
        function $(query) {
            return document.querySelector(query);
        }

        function renderEvent(event, index) {

            const card = HtmlCreator.createElement('div', { class: 'card' })
            const cardContent = HtmlCreator.createElement('div', { class: 'card-content' })
            const li = HtmlCreator.createElement('li', { id: 'li' + index, class: 'collection-item' })

            $('#Events').appendChild(card)
            card.appendChild(cardContent)
            cardContent.appendChild(li)
            let char = event.isNsfw ? '*' : '#'
            char += event.price == '' ? '!' : '$'
            li.appendChild(HtmlCreator.createElement('h4', {}, "Name: " + char + event.name))
            li.appendChild(HtmlCreator.createElement('p', {}, "id: " + event.uuid))
            li.appendChild(HtmlCreator.createElement('p', {}, "is nsfw: " + event.isNsfw))
            li.appendChild(HtmlCreator.createElement('p', {}, 'date: ' + event.date))
            li.appendChild(HtmlCreator.createElement('p', {}, 'price: '+ event.price))

            li.appendChild(HtmlCreator.createElement('button', {
                eventId: event.uuid,
                onClick: 'removeItem(eventId)',
                class: 'material-icons'
            },
                'delete'))

            li.appendChild(HtmlCreator.createElement('button', {
                eventId: event.uuid,
                onClick: 'AddClientToEvent(this.eventId)',
                class: 'material-icons'
            },
                'event_available'))

            li.appendChild(HtmlCreator.createElement('button', {
                eventId: event.uuid,
                onClick: 'filterAtendees(this.eventId, "Female")',
                class: 'material-icons'
            },
                'pregnant_woman'))

            li.appendChild(HtmlCreator.createElement('button', {
                eventId: event.uuid,
                onClick: 'filterAtendees(this.eventId, "Male")',
                class: 'material-icons'
            },
                'face'))

            li.appendChild(HtmlCreator.createElement('button', {
                eventId: event.uuid,
                onClick: 'filterAtendees(this.eventId)',
                class: 'material-icons'
            },
                'sentiment_satisfied'))

            const ul = HtmlCreator.createElement('ul', { id: 'ul' + index })
            const atendeesli = HtmlCreator.createElement('li', { id: event.uuid + 'atendeesList' })
            li.appendChild(ul)
            ul.appendChild(atendeesli)
            filterAtendees(event.uuid)

        }



        function removeItem(uuid) {
            LocalStorage.removeEvent(uuid, () => {
                alert("deleting items: sucess")
                window.location.reload(true);

            })
        }

        function AddClientToEvent(eventUuid) {
            if (!LocalStorage.isUserLoggedIn()) {
                window.location.href = "./login.html"
                return
            }

            let user = LocalStorage.getLoggedInUser();

            if (user == undefined) {
                alert("problem getting the user")
                return
            }
            LocalStorage.addClientToEvent(user, eventUuid)
            filterAtendees(eventUuid)
        }
        function filterAtendees(eventUuid, filter) {

            const event = LocalStorage.getEventById(eventUuid)
            let atendees = event.atendees
            const atendeesList = document.getElementById(event.uuid + 'atendeesList')
            atendeesList.innerHTML = ''

            if (filter != undefined)
                atendees = CollectionUtils.filter(atendees, (atendee) => {
                    const user = LocalStorage.getUserById(atendee)
                    return user.sex == filter
                })

            CollectionUtils.forEach(atendees, (atendee) => {
                const user = LocalStorage.getUserById(atendee)
                let p = HtmlCreator.createElement('p', {}, 
                'id: ' + user.uuid +
                ' age: ' + user.age +
                ' sex: ' + user.sex + 
                ' wallet: ' + user.wallet +
                ' attending events count: ' + user.events.length)
                let btn = HtmlCreator.createElement('button', {
                    eventId: event.uuid,
                    atendeeId: user.uuid,
                    onClick: 'removeAtendee(this.eventId, this.atendeeId)',
                    class: 'material-icons'
                },
                    'close')
                

                atendeesList.appendChild(p)
                atendeesList.appendChild(btn)
            })
        }

        function removeAtendee(eventId, userId) {
            LocalStorage.removeAtendeeFromEvent(eventId, userId)
            filterAtendees(eventId)
        }


    </script>
</body>

</html>